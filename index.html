<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="initial-scale=1,maximum-scale=1,user-scalable=no"
    />
    <title>3D Map with Coordinates Display</title>

    <style>
      html,
      body,
      #viewDiv {
        padding: 0;
        margin: 0;
        height: 100%;
        width: 100%;
      }

      #coordinateDiv {
        position: absolute;
        bottom: 10px;
        left: 10px;
        z-index: 9999;
        background-color: rgba(255, 255, 255, 0.9);
        padding: 10px;
        border: 1px solid #ccc;
        border-radius: 5px;
        font-family: Arial, sans-serif;
        font-size: 14px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
      }

      #miniMapDiv {
        position: absolute;
        top: 10px;
        right: 10px;
        width: 200px;
        height: 200px;
        border: 1px solid #ccc;
        border-radius: 5px;
        overflow: hidden;
      }
    </style>

    <link
      rel="stylesheet"
      href="https://js.arcgis.com/4.31/esri/themes/light/main.css"
    />
    <script src="https://js.arcgis.com/4.31/"></script>
  </head>

  <body>
    <div id="viewDiv"></div>
    <div id="coordinateDiv">Click on the map to get coordinates</div>
    <div id="miniMapDiv"></div>
    <!-- <iframe
      id="uploadTarget"
      name="uploadTarget"
      style="display: none"
    ></iframe> -->

    <script>
      require([
        "esri/Map",
        "esri/views/SceneView",
        "esri/layers/GraphicsLayer",
        "esri/Graphic",
        "esri/views/MapView",
      ], (Map, SceneView, GraphicsLayer, Graphic, MapView) => {
        // Create the map
        const map = new Map({
          basemap: "satellite",
        });

        // Create the SceneView
        const view = new SceneView({
          container: "viewDiv",
          map: map,
          constraints: {
            altitude: {
              max: 12000000000, // meters
            },
          },
        });

        // Create a GraphicsLayer to hold the pinpoints
        const satelliteTracks = new GraphicsLayer();
        map.add(satelliteTracks);

        // Create a separate map for the mini view
        const miniMap = new Map({
          basemap: "satellite",
        });

        // Create the mini map view
        const miniView = new MapView({
          container: "miniMapDiv",
          map: miniMap,
          zoom: 18, // Higher zoom level to show approximately 100m x 100m area
          ui: {
            components: [], // Remove all UI components from mini map
          },
          constraints: {
            minZoom: 18, // Lock zoom level
            maxZoom: 18,
            snapToZoom: false,
            rotationEnabled: false, // Prevent rotation
          },
        });

        // Function to capture and upload mini map image
        function captureMiniMapAndUpload() {
          // Make sure the mini map view is ready and visible
          if (!miniView.ready) {
            console.log("Mini map not ready yet, waiting...");
            setTimeout(captureMiniMapAndUpload, 500);
            return;
          }

          // Force a redraw of the mini map
          miniView
            .goTo(miniView.center)
            .then(() => {
              // Wait a bit longer to ensure rendering is complete
              setTimeout(() => {
                // Take a screenshot of the mini map
                miniView
                  .takeScreenshot({
                    format: "png",
                    quality: 100,
                    width: 200,
                    height: 200,
                  })
                  .then((screenshot) => {
                    try {
                      // Log the data URL to verify it's not empty
                      console.log(
                        "Screenshot taken, data URL length:",
                        screenshot.dataUrl.length
                      );

                      // Convert the screenshot to a Blob
                      fetch(screenshot.dataUrl)
                        .then((res) => res.blob())
                        .then((blob) => {
                          console.log("Blob size:", blob.size, "bytes");

                          // Create FormData to send the image
                          const formData = new FormData();
                          formData.append("image", blob, "minimap.png");

                          // Send the image to the backend
                          fetch("http://localhost:3000/upload", {
                            method: "POST",
                            body: formData,
                            mode: "cors",
                          })
                            .then((response) => {
                              if (response.ok) {
                                return response.json(); // Make sure to return this
                              } else {
                                throw new Error(
                                  "Failed to upload mini map image"
                                );
                              }
                            })
                            .then((data) => {
                              console.log(
                                "Mini map image uploaded successfully",
                                data
                              );
                              // Call the handleUploadResponse function with the data
                              window.handleUploadResponse(data);
                            })
                            .catch((error) => {
                              console.error(
                                "Error uploading mini map image:",
                                error
                              );
                            });
                        });
                    } catch (error) {
                      console.error("Error processing screenshot:", error);
                    }
                  })
                  .catch((error) => {
                    console.error(
                      "Error capturing mini map screenshot:",
                      error
                    );
                  });
              }, 1000); // Longer delay to ensure rendering
            })
            .catch((error) => {
              console.error("Error focusing mini map:", error);
            });
        }

        // Add click event to capture coordinates
        view.on("click", (event) => {
          event.stopPropagation();
          view.hitTest(event).then((response) => {
            // Remove existing pinpoints
            satelliteTracks.removeAll();

            // Get the map point where the user clicked
            const mapPoint = response.results.length
              ? response.results[0].mapPoint
              : event.mapPoint;

            if (mapPoint) {
              const { latitude, longitude } = mapPoint;

              // Update the coordinateDiv with clicked coordinates
              const coordinateDiv = document.getElementById("coordinateDiv");
              coordinateDiv.innerHTML = `Coordinates:<br>Latitude: ${latitude.toFixed(
                6
              )}<br>Longitude: ${longitude.toFixed(6)}`;

              // Create a pinpoint graphic
              const pinpoint = new Graphic({
                geometry: {
                  type: "point",
                  longitude: longitude,
                  latitude: latitude,
                },
                symbol: {
                  type: "simple-marker",
                  style: "circle",
                  color: "red",
                  size: "12px",
                  outline: {
                    color: "white",
                    width: 2,
                  },
                },
              });

              // Create a text graphic to show the coordinates
              const textGraphic = new Graphic({
                geometry: {
                  type: "point",
                  longitude: longitude,
                  latitude: latitude + 1,
                },
                symbol: {
                  type: "text",
                  color: "black",
                  haloColor: "white",
                  haloSize: "1px",
                  text: `Lat: ${latitude.toFixed(6)}\nLon: ${longitude.toFixed(
                    6
                  )}`,
                  font: {
                    size: 12,
                    family: "Arial",
                  },
                },
              });

              // Add the pinpoint and text label to the GraphicsLayer
              satelliteTracks.addMany([pinpoint, textGraphic]);

              // Update mini map center
              miniView.center = [longitude, latitude];

              // Wait a moment for the mini map to update before capturing
              setTimeout(() => {
                captureMiniMapAndUpload();
              }, 1500);
            }
          });
        });

        // Add this to your script
        window.handleUploadResponse = function (data) {
          console.log("Mini map image uploaded successfully");
          console.log("NDVI value:", data.ndvi);

          // Update the coordinate div to include NDVI
          const coordinateDiv = document.getElementById("coordinateDiv");
          const currentContent = coordinateDiv.innerHTML;
          coordinateDiv.innerHTML = `${currentContent}<br><br>NDVI: ${data.ndvi}`;

          // If you want to display the NDVI visualization image
          if (data.ndviImage) {
            const ndviImageUrl = `http://localhost:3000/uploads/${data.ndviImage}`;
            console.log("NDVI image URL:", ndviImageUrl);

            // Create or update NDVI image display
            let ndviDiv = document.getElementById("ndviDiv");
            if (!ndviDiv) {
              ndviDiv = document.createElement("div");
              ndviDiv.id = "ndviDiv";
              ndviDiv.style.position = "absolute";
              ndviDiv.style.bottom = "10px";
              ndviDiv.style.right = "10px";
              ndviDiv.style.width = "200px";
              ndviDiv.style.height = "200px";
              ndviDiv.style.border = "1px solid #ccc";
              ndviDiv.style.borderRadius = "5px";
              ndviDiv.style.overflow = "hidden";
              document.body.appendChild(ndviDiv);
            }

            // Set the NDVI image
            ndviDiv.innerHTML = `
              <div style="background-color: rgba(255, 255, 255, 0.9); padding: 5px; font-family: Arial, sans-serif; font-size: 12px;">
                NDVI Visualization
              </div>
              <img src="${ndviImageUrl}" style="width: 100%; height: calc(100% - 25px);">
            `;
          }
        };
      });
    </script>
  </body>
</html>
